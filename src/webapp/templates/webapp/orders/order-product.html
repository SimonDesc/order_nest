<div class="titre flex justify-left text-2xl font-bold mb-3">
	<h1 class="title">Nouveau produit</h1>
</div>
<form hx-post="{{ request.path }}" class="modal-content">
	{% csrf_token %}
	<div class="grid grid-cols-12 gap-3 mb-2">
		<!-- Première ligne -->

		<!-- Champ Descriptif -->
		<div class="col-span-8">
			{{ form.label.label_tag }}
			{{ form.label }}
		</div>

		<!-- Champ Libellé -->
		<div class="col-span-3">
			{{ form.size.label_tag }}
			{{ form.size }}
		</div>
	</div>

	<div class="grid grid-cols-12 gap-3 mb-2 items-end">
		<!-- Ligne oeuvre et marges -->
		<div class="col-span-2">
			{{ form.artwork_width.label_tag }}
			{{ form.artwork_width }}
		</div>
		<div class="col-span-2">
			{{ form.artwork_height.label_tag }}
			{{ form.artwork_height }}
		</div>
		<div class="col-span-2">
			{{ form.margin.label_tag }}
			{{ form.margin }}
		</div>
		<div class="col-span-2">
			{{ form.margin_height.label_tag }}
			{{ form.margin_height }}
		</div>
		<div class="col-span-3">
			{{ form.frame.label_tag }}
			{{ form.frame }}
		</div>
	</div>

	<div class="grid grid-cols-12 gap-3 mb-2">
		<!-- Champ Baguette -->
		<div class="col-span-3">
			{{ form.wand.label_tag }}
			{{ form.wand }}
		</div>

		<!-- Champ Verre -->
		<div class="col-span-3">
			{{ form.glass.label_tag }}
			{{ form.glass }}
		</div>

		<!-- Passe partout -->
		<div class="col-span-3">
			{{ form.mat.label_tag }}
			{{ form.mat }}
		</div>

		<!-- Filet -->
		<div class="col-span-2">
			{{ form.mesh.label_tag }}
			{{ form.mesh }}
		</div>
	</div>

	<div class="flex gap-4 mb-2">
		<!-- Colonne gauche: Visuel du cadre -->
		<div class="flex-shrink-0">
			<div class="relative" style="padding: 25px 35px 30px 30px;">
				<!-- Cotation verticale gauche - CADRE -->
				<div id="cot-cadre-v" class="absolute" style="display: none; left: 0; top: 25px; bottom: 30px; width: 25px;">
					<div style="position: absolute; left: 10px; top: 0; bottom: 0; width: 1px; background: #666;"></div>
					<div style="position: absolute; left: 6px; top: 0; width: 9px; height: 1px; background: #666;"></div>
					<div style="position: absolute; left: 6px; bottom: 0; width: 9px; height: 1px; background: #666;"></div>
					<div id="cot-cadre-v-val" style="position: absolute; left: -2px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 10px; color: #c00; font-weight: 600; white-space: nowrap;"></div>
				</div>

				<!-- Cotation horizontale bas - CADRE -->
				<div id="cot-cadre-h" class="absolute" style="display: none; left: 30px; right: 35px; bottom: 0; height: 25px;">
					<div style="position: absolute; top: 10px; left: 0; right: 0; height: 1px; background: #666;"></div>
					<div style="position: absolute; top: 6px; left: 0; width: 1px; height: 9px; background: #666;"></div>
					<div style="position: absolute; top: 6px; right: 0; width: 1px; height: 9px; background: #666;"></div>
					<div id="cot-cadre-h-val" style="position: absolute; top: 14px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #c00; font-weight: 600; white-space: nowrap;"></div>
				</div>

				<!-- Container du visuel -->
				<div id="visual-container" class="relative" style="transition: all 0.3s ease;">
					<div id="visual-cadre" style="display: block; padding: 0; background: transparent; border-radius: 3px;">
						<div id="visual-passe-partout" style="padding: 0; background: transparent;">
							<div id="visual-filet" style="padding: 0; background: transparent;">
								<div id="visual-oeuvre" style="width: 120px; height: 100px; background: linear-gradient(135deg, #fff, #f0f0f0); border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
									<span id="visual-oeuvre-label" style="font-size: 10px; color: #666; text-align: center; line-height: 1.3;"></span>
								</div>
							</div>
						</div>
					</div>
					<div id="visual-verre-reflet" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; border-radius: 3px; overflow: hidden;">
						<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.1) 30%, transparent 50%);"></div>
						<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(200,220,240,0.08);"></div>
						<div style="position: absolute; bottom: 10%; right: 10%; width: 20%; height: 15%; background: rgba(255,255,255,0.15); filter: blur(8px); border-radius: 50%;"></div>
					</div>
				</div>
			</div>
			<!-- Légende des cotations -->
			<div id="cot-legend" class="flex justify-center gap-4 text-xs" style="display: none;">
				<div class="flex items-center gap-1">
					<span style="width: 10px; height: 2px; background: #c00;"></span>
					<span class="text-gray-600">Cadre</span>
				</div>
			</div>
		</div>

		<!-- Colonne droite: Prix, Terminée, Boutons -->
		<div class="flex-1 flex flex-col justify-between">
			<div>
				<div class="grid grid-cols-2 gap-4 mb-3">
					<div>
						{{ form.selling_price_unit.label_tag }}
						{{ form.selling_price_unit }}
					</div>
					<div class="text-center">
						Commande terminée
						<div class="flex justify-center mt-2">
							<div class="checkbox-wrapper-12">
							{{ form.status }}
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="flex justify-end gap-3">
				<button style="background-color: #FF4E27; border-radius: 10px;" type="button" id="cancelButton" class="py-2 px-4 text-sm text-white focus:outline-none focus:z-10 focus:ring-4 focus:ring-gray-200">
					Annuler
				</button>
				<button type="submit" class="blue-button py-2 px-5 text-sm text-white focus:outline-none rounded-xl focus:z-10 focus:ring-4 focus:ring-gray-200 cursor-pointer transition-all hover:-translate-y-[1px] active:border-b-[2px] active:brightness-90 active:translate-y-[2px]">
					Enregistrer
				</button>
			</div>
		</div>
	</div>
</form>

<script>
(function() {
	// Éléments du formulaire
	const width = document.getElementById('id_artwork_width');
	const height = document.getElementById('id_artwork_height');
	const marginW = document.getElementById('id_margin');
	const marginH = document.getElementById('id_margin_height');
	const frameInput = document.getElementById('id_frame');
	const glassSelect = document.getElementById('id_glass');
	const matInput = document.getElementById('id_mat');
	const meshInput = document.getElementById('id_mesh');
	const wandInput = document.getElementById('id_wand');

	// Éléments visuels
	const visualCadre = document.getElementById('visual-cadre');
	const visualOeuvre = document.getElementById('visual-oeuvre');
	const visualOeuvreLabel = document.getElementById('visual-oeuvre-label');
	const visualPassePartout = document.getElementById('visual-passe-partout');
	const visualFilet = document.getElementById('visual-filet');
	const visualVerre = document.getElementById('visual-verre-reflet');

	// Cotations
	const cotCadreH = document.getElementById('cot-cadre-h');
	const cotCadreV = document.getElementById('cot-cadre-v');
	const cotCadreHVal = document.getElementById('cot-cadre-h-val');
	const cotCadreVVal = document.getElementById('cot-cadre-v-val');
	const cotLegend = document.getElementById('cot-legend');

	// Échelle et limites
	const SCALE = 1.5;
	const MIN_SIZE = 80;
	const MAX_SIZE = 160;
	const MIN_MARGIN = 10;
	const MAX_MARGIN = 35;

	function clamp(val, min, max) {
		return Math.max(min, Math.min(max, val));
	}

	function hasValue(input) {
		return input && input.value && input.value.trim() !== '' && input.value !== 'Sans';
	}

	function updateVisual() {
		const w = parseFloat(width.value);
		const h = parseFloat(height.value);
		const mW = parseFloat(marginW.value);
		const mH = parseFloat(marginH.value);

		const hasMargins = !isNaN(mW) && !isNaN(mH) && mW > 0 && mH > 0;
		const hasBaguette = hasValue(wandInput);
		const hasVerre = hasValue(glassSelect);
		const hasMat = hasValue(matInput);
		const hasFilet = hasValue(meshInput);

		// Calculer taille oeuvre proportionnelle
		let oeuvreW = 120, oeuvreH = 100;
		if (!isNaN(w) && !isNaN(h) && w > 0 && h > 0) {
			const ratio = w / h;
			if (ratio > 1) {
				oeuvreW = clamp(w * SCALE, MIN_SIZE, MAX_SIZE);
				oeuvreH = oeuvreW / ratio;
			} else {
				oeuvreH = clamp(h * SCALE, MIN_SIZE, MAX_SIZE);
				oeuvreW = oeuvreH * ratio;
			}
		}

		// Appliquer taille oeuvre
		visualOeuvre.style.width = oeuvreW + 'px';
		visualOeuvre.style.height = oeuvreH + 'px';

		// Cadre visible si marges renseignées
		if (hasMargins) {
			visualCadre.style.display = 'block';
			const padCadre = clamp(Math.max(mW, mH) * SCALE * 0.3, 6, 12);
			visualCadre.style.padding = padCadre + 'px';

			// Style baguette si renseignée
			if (hasBaguette) {
				visualCadre.style.background = 'linear-gradient(145deg, #8B7355, #6B5344)';
				visualCadre.style.boxShadow = 'inset 0 0 8px rgba(0,0,0,0.3), 2px 2px 6px rgba(0,0,0,0.2)';
			} else {
				visualCadre.style.background = '#a08060';
				visualCadre.style.boxShadow = '2px 2px 6px rgba(0,0,0,0.2)';
			}
		} else {
			visualCadre.style.display = 'block';
			visualCadre.style.padding = '0';
			visualCadre.style.background = 'transparent';
			visualCadre.style.boxShadow = 'none';
		}

		// Passe-partout (utilise les marges pour le padding)
		if (hasMat && hasMargins) {
			const padLR = clamp(mW * SCALE, MIN_MARGIN, MAX_MARGIN);
			const padTB = clamp(mH * SCALE, MIN_MARGIN, MAX_MARGIN);
			visualPassePartout.style.padding = padTB + 'px ' + padLR + 'px';
			// Couleur basée sur le texte
			const mat = matInput.value.toLowerCase();
			if (mat.includes('noir')) {
				visualPassePartout.style.background = '#2d2d2d';
			} else if (mat.includes('blanc')) {
				visualPassePartout.style.background = '#fafafa';
			} else if (mat.includes('beige')) {
				visualPassePartout.style.background = '#f5f5dc';
			} else if (mat.includes('gris')) {
				visualPassePartout.style.background = '#9ca3af';
			} else {
				visualPassePartout.style.background = '#f5f5f0';
			}
			visualPassePartout.style.boxShadow = 'inset 0 0 3px rgba(0,0,0,0.1)';
		} else {
			visualPassePartout.style.padding = '0';
			visualPassePartout.style.background = 'transparent';
			visualPassePartout.style.boxShadow = 'none';
		}

		// Filet
		if (hasFilet) {
			visualFilet.style.padding = '3px';
			visualFilet.style.background = 'linear-gradient(145deg, #c9a227, #b8931f)';
		} else {
			visualFilet.style.padding = '0';
			visualFilet.style.background = 'transparent';
		}

		// Verre (reflet)
		visualVerre.style.display = hasVerre ? 'block' : 'none';

		// Calculer dimensions
		const frameW = !isNaN(w) && !isNaN(mW) ? w + mW * 2 : null;
		const frameH = !isNaN(h) && !isNaN(mH) ? h + mH * 2 : null;

		// Afficher dimension cadre dans le champ
		if (frameW && frameH) {
			frameInput.value = frameW + ' × ' + frameH;
		}

		// Cotations
		if (hasMargins && frameW && frameH) {
			cotCadreH.style.display = 'block';
			cotCadreV.style.display = 'block';
			cotCadreHVal.textContent = frameW + ' cm';
			cotCadreVVal.textContent = frameH + ' cm';
			cotLegend.style.display = 'flex';
		} else {
			cotCadreH.style.display = 'none';
			cotCadreV.style.display = 'none';
			cotLegend.style.display = 'none';
		}

		// Label oeuvre avec dimensions
		if (!isNaN(w) && !isNaN(h)) {
			visualOeuvreLabel.innerHTML = 'OEUVRE<br><span style="font-size:10px; color:#999;">' + w + ' × ' + h + '</span>';
		} else {
			visualOeuvreLabel.innerHTML = 'OEUVRE';
		}
	}

	// Event listeners
	width.addEventListener('input', updateVisual);
	height.addEventListener('input', updateVisual);
	marginW.addEventListener('input', updateVisual);
	marginH.addEventListener('input', updateVisual);
	if (wandInput) wandInput.addEventListener('input', updateVisual);
	if (glassSelect) glassSelect.addEventListener('change', updateVisual);
	if (matInput) matInput.addEventListener('input', updateVisual);
	if (meshInput) meshInput.addEventListener('input', updateVisual);

	// Init - appel immédiat + délai pour s'assurer que les valeurs sont chargées
	updateVisual();
	setTimeout(updateVisual, 100);
})();
</script>
