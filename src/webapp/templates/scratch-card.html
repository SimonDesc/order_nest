<!-- Ticket √† Gratter Quotidien ‚Äî Style Solitaire (1 zone de grattage + symboles machine √† sous) -->
<style>
    .scratch-overlay {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        justify-content: center;
        align-items: center;
        animation: scratchFadeIn 0.3s ease;
    }
    .scratch-overlay.active {
        display: flex;
    }
    .scratch-container {
        position: relative;
        background: linear-gradient(145deg, #1a0a2e, #0d0015, #1a0a2e);
        border-radius: 24px;
        padding: 28px 24px 24px;
        max-width: 420px;
        width: 92vw;
        box-shadow:
            0 0 40px rgba(255, 215, 0, 0.3),
            0 0 80px rgba(255, 215, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 215, 0, 0.4);
        animation: scratchPopIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .scratch-close-btn {
        position: absolute;
        top: 10px;
        right: 14px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 24px;
        cursor: pointer;
        transition: color 0.2s, transform 0.2s;
        z-index: 2;
    }
    .scratch-close-btn:hover {
        color: #ffd700;
        transform: scale(1.2);
    }
    .scratch-title {
        text-align: center;
        font-size: 22px;
        font-weight: 800;
        background: linear-gradient(to right, #ffd700, #ffaa00, #ffd700);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 6px;
        letter-spacing: 2px;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.4));
    }
    .scratch-subtitle {
        text-align: center;
        color: rgba(255, 255, 255, 0.5);
        font-size: 12px;
        margin-bottom: 16px;
        letter-spacing: 1px;
    }

    /* Cadre du ticket (contenu + canvas) */
    .scratch-ticket-frame {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        border: 3px solid rgba(255, 215, 0, 0.4);
        box-shadow:
            0 0 20px rgba(255, 215, 0, 0.15),
            inset 0 0 30px rgba(0, 0, 0, 0.3);
        margin-bottom: 12px;
        background: linear-gradient(135deg, #1a0a2e, #2a1050, #1a0a2e);
    }

    /* Contenu sous le canvas */
    .scratch-content-layer {
        padding: 14px 14px 10px;
    }

    /* Section symboles chanceux */
    .scratch-lucky-section {
        text-align: center;
        margin-bottom: 8px;
    }
    .scratch-lucky-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
        letter-spacing: 1px;
    }
    .scratch-lucky-row {
        display: flex;
        justify-content: center;
        gap: 14px;
    }
    .scratch-lucky-cell {
        width: 62px;
        height: 62px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1e1145, #2d1a6b);
        border-radius: 12px;
        border: 2px solid rgba(255, 215, 0, 0.2);
        font-size: 30px;
    }

    /* S√©parateur */
    .scratch-separator {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
        margin: 10px 0;
    }

    /* Grille 3x3 */
    .scratch-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
        max-width: 270px;
        margin: 0 auto;
    }
    .scratch-grid-cell {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #150828, #1f0d3a);
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.08);
        transition: border-color 0.3s, background 0.3s, box-shadow 0.3s;
    }
    .scratch-grid-cell .scratch-cell-symbol {
        font-size: 28px;
        line-height: 1;
    }
    .scratch-grid-cell .scratch-cell-credits {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 3px;
        transition: color 0.3s;
    }

    /* Cellule gagnante */
    .scratch-grid-cell.winner {
        border-color: #ffd700;
        background: linear-gradient(135deg, #2a1a00, #3d2800);
        box-shadow: 0 0 18px rgba(255, 215, 0, 0.5), inset 0 0 12px rgba(255, 215, 0, 0.15);
        animation: scratchWinnerPulse 0.5s ease;
    }
    .scratch-grid-cell.winner .scratch-cell-symbol {
        filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
    }
    .scratch-grid-cell.winner .scratch-cell-credits {
        color: #ffd700;
        font-weight: 700;
    }

    /* Canvas de grattage */
    .scratch-canvas {
        position: absolute;
        inset: 0;
        cursor: crosshair;
        touch-action: none;
        border-radius: 13px;
    }

    /* Indication */
    .scratch-hint {
        text-align: center;
        color: rgba(255, 255, 255, 0.4);
        font-size: 13px;
        margin-bottom: 12px;
        min-height: 20px;
        transition: opacity 0.3s;
    }

    /* R√©sultat */
    .scratch-result {
        text-align: center;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .scratch-result-text {
        font-size: 20px;
        font-weight: 700;
        opacity: 0;
        transition: opacity 0.3s;
        color: #ffd700;
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }
    .scratch-result-text.visible {
        opacity: 1;
    }
    .scratch-result-text.mega {
        font-size: 26px;
        animation: scratchRainbow 0.6s linear infinite;
    }
    .scratch-result-text.lose {
        color: rgba(255, 255, 255, 0.5);
        text-shadow: none;
    }

    /* Message "reviens demain" */
    .scratch-comeback {
        text-align: center;
        padding: 40px 20px;
    }
    .scratch-comeback-emoji {
        font-size: 64px;
        margin-bottom: 16px;
    }
    .scratch-comeback-text {
        font-size: 20px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 8px;
    }
    .scratch-comeback-sub {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.4);
    }

    /* Bouton sidebar */
    .scratch-sidebar-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        position: relative;
    }
    .scratch-sidebar-btn::after {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 12px;
        background: radial-gradient(circle, rgba(255, 215, 0, 0.15), transparent);
        animation: scratchBtnPulse 3s ease-in-out infinite;
    }
    .scratch-sidebar-icon {
        width: 40px;
        height: 40px;
        transition: transform 0.3s, filter 0.3s;
    }
    .scratch-sidebar-btn:hover .scratch-sidebar-icon {
        transform: scale(1.15) rotate(-5deg);
        filter: drop-shadow(0 0 6px rgba(255, 215, 0, 0.6));
    }

    /* Badge "1" disponible */
    .scratch-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 18px;
        height: 18px;
        background: #ff2d55;
        border-radius: 50%;
        color: white;
        font-size: 11px;
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        box-shadow: 0 0 8px rgba(255, 45, 85, 0.6);
    }
    .scratch-badge.hidden {
        display: none;
    }

    /* Confettis */
    #scratch-confetti {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 10000;
        overflow: hidden;
    }
    .scratch-confetti-particle {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 2px;
        top: 50%;
        animation: scratchConfetti 2.5s ease-out forwards;
    }

    /* Animations */
    @keyframes scratchFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes scratchPopIn {
        from { transform: scale(0.85); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    @keyframes scratchRainbow {
        0% { color: #ff2d55; text-shadow: 0 0 20px rgba(255,45,85,0.8); }
        25% { color: #ffd700; text-shadow: 0 0 20px rgba(255,215,0,0.8); }
        50% { color: #00ff88; text-shadow: 0 0 20px rgba(0,255,136,0.8); }
        75% { color: #00d4ff; text-shadow: 0 0 20px rgba(0,212,255,0.8); }
        100% { color: #ff2d55; text-shadow: 0 0 20px rgba(255,45,85,0.8); }
    }
    @keyframes scratchBtnPulse {
        0%, 100% { opacity: 0; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1.1); }
    }
    @keyframes scratchConfetti {
        0% {
            transform: translate(0, 0) rotate(0deg) scale(1);
            opacity: 1;
        }
        100% {
            transform: translate(var(--confetti-x), var(--confetti-y)) rotate(var(--confetti-r)) scale(0);
            opacity: 0;
        }
    }
    @keyframes scratchShake {
        0%, 100% { transform: translateX(0); }
        10% { transform: translateX(-8px) rotate(-1deg); }
        20% { transform: translateX(8px) rotate(1deg); }
        30% { transform: translateX(-6px) rotate(-0.5deg); }
        40% { transform: translateX(6px) rotate(0.5deg); }
        50% { transform: translateX(-4px); }
        60% { transform: translateX(4px); }
        70% { transform: translateX(-2px); }
        80% { transform: translateX(2px); }
    }
    @keyframes scratchWinnerPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.08); }
        100% { transform: scale(1); }
    }
    @keyframes scratchRevealPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.03); }
        100% { transform: scale(1); }
    }
</style>

<!-- Ticket √† Gratter -->
<div id="scratch-overlay" class="scratch-overlay">
    <div id="scratch-confetti"></div>
    <div id="scratch-container" class="scratch-container">
        <button class="scratch-close-btn" onclick="scratchCard.close()">&times;</button>
        <div class="scratch-title">TICKET √Ä GRATTER</div>
        <div class="scratch-subtitle">1 ticket gratuit par jour</div>

        <!-- Contenu quand le ticket est disponible -->
        <div id="scratch-game-area">
            <div class="scratch-ticket-frame" id="scratch-ticket-frame">
                <!-- Contenu visible sous le grattage -->
                <div class="scratch-content-layer">
                    <div class="scratch-lucky-section">
                        <div class="scratch-lucky-label">&#9733; Tes symboles chanceux &#9733;</div>
                        <div class="scratch-lucky-row">
                            <div class="scratch-lucky-cell" id="scratch-lucky-0">
                                <span id="scratch-lucky-sym-0"></span>
                            </div>
                            <div class="scratch-lucky-cell" id="scratch-lucky-1">
                                <span id="scratch-lucky-sym-1"></span>
                            </div>
                        </div>
                    </div>
                    <div class="scratch-separator"></div>
                    <div class="scratch-grid" id="scratch-grid"></div>
                </div>
                <!-- Canvas de grattage par-dessus -->
                <canvas class="scratch-canvas" id="scratch-canvas"></canvas>
            </div>
            <div class="scratch-hint" id="scratch-hint">Gratte le ticket avec ton doigt ou ta souris !</div>
            <div class="scratch-result">
                <span class="scratch-result-text" id="scratch-result"></span>
            </div>
        </div>

        <!-- Contenu quand d√©j√† gratt√© -->
        <div id="scratch-comeback-area" style="display: none;">
            <div class="scratch-comeback">
                <div class="scratch-comeback-emoji">üò¥</div>
                <div class="scratch-comeback-text">Reviens demain !</div>
                <div class="scratch-comeback-sub">Tu as d√©j√† gratt√© ton ticket aujourd'hui.</div>
            </div>
        </div>
    </div>
</div>

<script>
const scratchCard = (() => {
    // Symboles identiques √† la machine √† sous
    const SYMBOLS = ['üçí', 'üçã', 'üçä', 'üçá', 'üîî', '‚≠ê', 'üíé'];

    // Table des gains pond√©r√©e
    const PRIZE_TABLE = [
        { credits: 0,   weight: 5 },
        { credits: 10,  weight: 6 },
        { credits: 20,  weight: 4 },
        { credits: 30,  weight: 3 },
        { credits: 50,  weight: 3 },
        { credits: 75,  weight: 2 },
        { credits: 150, weight: 1 },
        { credits: 500, weight: 1 },
    ];

    var pool = [];
    PRIZE_TABLE.forEach(function(p) { for (var i = 0; i < p.weight; i++) pool.push(p.credits); });

    // R√©partitions possibles par total
    var SPLIT_CONFIGS = {
        10:  [[10], [5, 5]],
        20:  [[20], [10, 10]],
        30:  [[30], [20, 10], [10, 10, 10]],
        50:  [[50], [30, 20], [20, 20, 10]],
        75:  [[75], [50, 25], [25, 25, 25]],
        150: [[150], [100, 50], [50, 50, 50]],
        500: [[500], [300, 200], [200, 200, 100]],
    };

    var canvas, ctx;
    var isScratching = false;
    var revealed = false;
    var ticket = null;

    // --- Utilitaires ---

    function todayStr() {
        return new Date().toISOString().slice(0, 10);
    }

    function isAvailableToday() {
        return localStorage.getItem('scratchLastDate') !== todayStr();
    }

    function updateBadge() {
        var badge = document.getElementById('scratch-badge');
        if (badge) {
            if (isAvailableToday()) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }
    }

    function shuffle(arr) {
        for (var i = arr.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
        }
        return arr;
    }

    // --- G√©n√©ration du ticket ---

    function pickTotal() {
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function pickLuckySymbols() {
        var shuffled = SYMBOLS.slice();
        shuffle(shuffled);
        return [shuffled[0], shuffled[1]];
    }

    function splitTotal(total) {
        if (total === 0) return [];
        var options = SPLIT_CONFIGS[total];
        return options[Math.floor(Math.random() * options.length)];
    }

    function pickLosingSymbol(luckySyms) {
        var available = SYMBOLS.filter(function(s) { return luckySyms.indexOf(s) === -1; });
        return available[Math.floor(Math.random() * available.length)];
    }

    function pickFakeCredits() {
        var fakes = [5, 10, 15, 20, 25, 30, 50, 75];
        return fakes[Math.floor(Math.random() * fakes.length)];
    }

    function generateTicket() {
        var totalCredits = pickTotal();
        var luckySymbols = pickLuckySymbols();
        var winSplits = splitTotal(totalCredits);

        var cells = [];

        // Cases gagnantes : symbole = un des 2 chanceux
        for (var i = 0; i < winSplits.length; i++) {
            cells.push({
                symbol: luckySymbols[Math.floor(Math.random() * 2)],
                credits: winSplits[i],
                isWinner: true,
            });
        }

        // Cases perdantes : symbole diff√©rent des 2 chanceux
        for (var i = winSplits.length; i < 9; i++) {
            cells.push({
                symbol: pickLosingSymbol(luckySymbols),
                credits: pickFakeCredits(),
                isWinner: false,
            });
        }

        shuffle(cells);
        return { totalCredits: totalCredits, luckySymbols: luckySymbols, grid: cells };
    }

    // --- Construction de l'interface ---

    function buildUI() {
        // Symboles chanceux
        document.getElementById('scratch-lucky-sym-0').textContent = ticket.luckySymbols[0];
        document.getElementById('scratch-lucky-sym-1').textContent = ticket.luckySymbols[1];

        // Grille 3x3
        var gridEl = document.getElementById('scratch-grid');
        gridEl.innerHTML = '';

        ticket.grid.forEach(function(cell, i) {
            var cellEl = document.createElement('div');
            cellEl.className = 'scratch-grid-cell';
            cellEl.id = 'scratch-grid-' + i;
            cellEl.innerHTML =
                '<span class="scratch-cell-symbol">' + cell.symbol + '</span>' +
                '<span class="scratch-cell-credits">' + cell.credits + ' cr.</span>';
            gridEl.appendChild(cellEl);
        });
    }

    // --- Canvas de grattage ---

    function initCanvas() {
        canvas = document.getElementById('scratch-canvas');
        var frame = document.getElementById('scratch-ticket-frame');
        canvas.width = frame.offsetWidth;
        canvas.height = frame.offsetHeight;
        ctx = canvas.getContext('2d');

        // Gradient violet/rose
        var grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        grad.addColorStop(0, '#6b21a8');
        grad.addColorStop(0.3, '#db2777');
        grad.addColorStop(0.6, '#7c3aed');
        grad.addColorStop(1, '#ec4899');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Etoiles d√©coratives
        drawStars();

        // Texte "GRATTE ICI"
        ctx.save();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.25)';
        ctx.font = 'bold 22px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('GRATTE ICI !', canvas.width / 2, canvas.height / 2);
        ctx.restore();

        // Event listeners
        canvas.addEventListener('mousedown', startScratch);
        canvas.addEventListener('mousemove', doScratch);
        canvas.addEventListener('mouseup', stopScratch);
        canvas.addEventListener('mouseleave', stopScratch);
        canvas.addEventListener('touchstart', startScratch, { passive: false });
        canvas.addEventListener('touchmove', doScratch, { passive: false });
        canvas.addEventListener('touchend', stopScratch);
    }

    function drawStars() {
        ctx.save();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
        for (var i = 0; i < 30; i++) {
            var x = Math.random() * canvas.width;
            var y = Math.random() * canvas.height;
            var size = 1 + Math.random() * 3;
            ctx.beginPath();
            ctx.arc(x, y, size * 0.5, 0, Math.PI * 2);
            ctx.fill();
            // Petites branches
            for (var j = 0; j < 4; j++) {
                var angle = (j * Math.PI) / 2;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + Math.cos(angle) * size, y + Math.sin(angle) * size);
                ctx.strokeStyle = 'rgba(255, 255, 255, ' + (0.08 + Math.random() * 0.1) + ')';
                ctx.lineWidth = 0.5;
                ctx.stroke();
            }
        }
        ctx.restore();
    }

    function getPos(e) {
        var rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
            return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        }
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function startScratch(e) {
        if (revealed) return;
        e.preventDefault();
        isScratching = true;
        doScratch(e);
    }

    function doScratch(e) {
        if (!isScratching || revealed) return;
        e.preventDefault();
        var pos = getPos(e);
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 25, 0, Math.PI * 2);
        ctx.fill();
        checkScratchProgress();
    }

    function stopScratch() {
        isScratching = false;
    }

    function checkScratchProgress() {
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var transparent = 0;
        for (var i = 3; i < imageData.data.length; i += 16) {
            if (imageData.data[i] === 0) transparent++;
        }
        var totalSampled = Math.ceil(imageData.data.length / 16);
        if (transparent / totalSampled > 0.75) {
            revealAll();
        }
    }

    // --- R√©v√©lation & feedback ---

    function revealAll() {
        if (revealed) return;
        revealed = true;

        // Effacer le canvas
        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0, 0, 0, 1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Pulse du cadre
        var frame = document.getElementById('scratch-ticket-frame');
        frame.style.animation = 'scratchRevealPulse 0.5s ease';
        setTimeout(function() { frame.style.animation = ''; }, 500);

        // Marquer comme gratt√©
        localStorage.setItem('scratchLastDate', todayStr());
        updateBadge();

        // Masquer le hint
        document.getElementById('scratch-hint').style.opacity = '0';

        // Lancer la s√©quence de feedback
        highlightWinners();
    }

    function highlightWinners() {
        // Trouver les cases gagnantes (symbole = un des symboles chanceux)
        var winners = [];
        for (var i = 0; i < 9; i++) {
            if (ticket.luckySymbols.indexOf(ticket.grid[i].symbol) !== -1) {
                winners.push(i);
            }
        }

        if (winners.length === 0) {
            // Pas de gain : afficher le r√©sultat apr√®s une courte pause
            setTimeout(showResult, 600);
            return;
        }

        // Illuminer les gagnants un par un
        winners.forEach(function(cellIndex, i) {
            setTimeout(function() {
                document.getElementById('scratch-grid-' + cellIndex).classList.add('winner');
                playSound('match');
            }, 400 + i * 450);
        });

        // Afficher le r√©sultat apr√®s le dernier gagnant
        setTimeout(showResult, 400 + winners.length * 450 + 400);
    }

    function showResult() {
        // Ajouter les cr√©dits
        var stored = localStorage.getItem('slotCredits');
        var credits = stored !== null ? parseInt(stored) : 100;
        credits += ticket.totalCredits;
        localStorage.setItem('slotCredits', credits);

        // Mettre √† jour l'affichage machine √† sous si visible
        var slotCreditsEl = document.getElementById('slot-credits');
        if (slotCreditsEl) slotCreditsEl.textContent = credits;

        // Afficher le r√©sultat
        var resultEl = document.getElementById('scratch-result');

        if (ticket.totalCredits === 0) {
            resultEl.textContent = 'Pas de chance...';
            resultEl.className = 'scratch-result-text visible lose';
        } else if (ticket.totalCredits >= 150) {
            resultEl.textContent = '+' + ticket.totalCredits + ' cr√©dits !';
            resultEl.className = 'scratch-result-text visible mega';
            shakeScreen();
            createConfetti(120);
            playSound('jackpot');
        } else if (ticket.totalCredits >= 75) {
            resultEl.textContent = '+' + ticket.totalCredits + ' cr√©dits !';
            resultEl.className = 'scratch-result-text visible';
            createConfetti(60);
            playSound('bigWin');
        } else {
            resultEl.textContent = '+' + ticket.totalCredits + ' cr√©dits !';
            resultEl.className = 'scratch-result-text visible';
            createConfetti(30);
            playSound('win');
        }
    }

    // --- Ouverture / Fermeture ---

    function open() {
        var overlay = document.getElementById('scratch-overlay');
        overlay.classList.add('active');

        // Reset √©tat
        revealed = false;
        isScratching = false;
        document.getElementById('scratch-result').className = 'scratch-result-text';
        document.getElementById('scratch-result').textContent = '';
        document.getElementById('scratch-hint').style.opacity = '1';

        if (!isAvailableToday()) {
            document.getElementById('scratch-game-area').style.display = 'none';
            document.getElementById('scratch-comeback-area').style.display = 'block';
        } else {
            document.getElementById('scratch-game-area').style.display = 'block';
            document.getElementById('scratch-comeback-area').style.display = 'none';

            ticket = generateTicket();
            buildUI();

            // Attendre que le DOM soit rendu pour dimensionner le canvas
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    initCanvas();
                });
            });
        }
    }

    function close() {
        document.getElementById('scratch-overlay').classList.remove('active');
    }

    // --- Effets visuels ---

    function shakeScreen() {
        var el = document.getElementById('scratch-container');
        el.style.animation = 'scratchShake 0.6s ease';
        setTimeout(function() { el.style.animation = ''; }, 600);
    }

    function createConfetti(count) {
        var container = document.getElementById('scratch-confetti');
        var colors = ['#ff2d55', '#ffd700', '#00ff88', '#00d4ff', '#ff6b35', '#a855f7', '#ec4899'];

        for (var i = 0; i < count; i++) {
            var particle = document.createElement('div');
            particle.className = 'scratch-confetti-particle';
            var angle = Math.random() * Math.PI * 2;
            var distance = 100 + Math.random() * 400;
            var x = Math.cos(angle) * distance;
            var y = Math.sin(angle) * distance - 200;

            particle.style.left = '50%';
            particle.style.setProperty('--confetti-x', x + 'px');
            particle.style.setProperty('--confetti-y', y + 'px');
            particle.style.setProperty('--confetti-r', (Math.random() * 720 - 360) + 'deg');
            particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            particle.style.animationDelay = (Math.random() * 0.3) + 's';
            particle.style.animationDuration = (1.5 + Math.random() * 1.5) + 's';
            particle.style.width = (4 + Math.random() * 8) + 'px';
            particle.style.height = (4 + Math.random() * 8) + 'px';
            particle.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';

            container.appendChild(particle);
            setTimeout((function(p) { return function() { p.remove(); }; })(particle), 3500);
        }
    }

    // --- Sons via Web Audio API ---

    var audioCtx = null;
    function getAudioCtx() {
        if (!audioCtx) {
            try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
            catch (e) { return null; }
        }
        return audioCtx;
    }

    function playTone(freq, duration, type, volume) {
        var ctx = getAudioCtx();
        if (!ctx) return;
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.type = type || 'sine';
        osc.frequency.value = freq;
        gain.gain.value = volume || 0.08;
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + duration);
    }

    function playSound(type) {
        try {
            switch (type) {
                case 'match':
                    playTone(659, 0.1, 'sine', 0.08);
                    setTimeout(function() { playTone(880, 0.15, 'sine', 0.08); }, 80);
                    break;
                case 'win':
                    playTone(523, 0.12, 'sine', 0.08);
                    setTimeout(function() { playTone(659, 0.12, 'sine', 0.08); }, 100);
                    setTimeout(function() { playTone(784, 0.2, 'sine', 0.08); }, 200);
                    break;
                case 'bigWin':
                    [523, 587, 659, 784, 880].forEach(function(f, i) {
                        setTimeout(function() { playTone(f, 0.15, 'sine', 0.08); }, i * 80);
                    });
                    break;
                case 'jackpot':
                    [523, 659, 784, 1047, 784, 1047, 1319].forEach(function(f, i) {
                        setTimeout(function() { playTone(f, 0.2, 'sine', 0.1); }, i * 100);
                    });
                    break;
            }
        } catch (e) {}
    }

    // Initialiser le badge au chargement
    document.addEventListener('DOMContentLoaded', updateBadge);

    return { open: open, close: close, updateBadge: updateBadge };
})();
</script>
